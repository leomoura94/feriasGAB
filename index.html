<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Agendamento de Férias - 2026</title>
<style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; padding: 20px; }
    h1 { text-align: center; }
    .container { max-width: 900px; margin: auto; background: #fff; padding: 20px; border-radius: 10px; }
    label { font-weight: bold; display: block; margin-top: 10px; }
    input, select, button { padding: 8px; margin-top: 5px; width: 100%; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #eee; }
    .btn { cursor: pointer; border: none; border-radius: 5px; padding: 5px 10px; }
    .aprovado { background: green; color: white; }
    .negado { background: red; color: white; }
    .pendente { background: orange; color: white; }
</style>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
</head>
<body>

<div class="container">
    <h1>Agendamento de Férias - 2026</h1>

    <div id="formulario">
        <label>Nome do Colaborador:</label>
        <select id="colaborador"></select>

        <label>Data de Início:</label>
        <input type="date" id="inicio">

        <label>Duração das férias:</label>
        <select id="duracao">
            <option value="">Selecione</option>
            <option value="15">15 dias</option>
            <option value="20">20 dias</option>
            <option value="30">30 dias</option>
        </select>

        <p id="infoRetorno" style="font-weight: bold; color: blue;"></p>

        <button class="btn" onclick="agendarFerias()">Agendar</button>
    </div>

    <hr>

    <h2>Solicitações</h2>
    <button onclick="baixarCSV()" style="margin-bottom: 10px;">Baixar solicitações (CSV)</button>
    <button onclick="baixarExcel()" style="margin-left:10px; margin-bottom: 10px;">Baixar Excel (.xlsx)</button>

    <table>
        <thead>
            <tr>
                <th>Colaborador</th>
                <th>Início</th>
                <th>Fim</th>
                <th>Retorno</th>
                <th>Status</th>
                <th>Ações (Supervisor)</th>
                <th>Formulário RH</th>
            </tr>
        </thead>
        <tbody id="listaFerias"></tbody>
    </table>

    <hr>

    <h2>Login Supervisor</h2>
    <input type="password" id="senhaSupervisor" placeholder="Senha do supervisor" style="width: 200px;">
    <button onclick="loginSupervisor()" style="width: 120px;">Entrar</button>
</div>

<script>
const colaboradores = [
    { nome: "ALEXANDRE RIBEIRO GUARANY LIRA", admissao: "2023-04-19" },
    { nome: "ALISON RODRIGO GOMES DA CRUZ", admissao: "2023-10-02" },
    { nome: "ANTONIO LEONARDO ROCHA", admissao: "2023-11-27" },
    { nome: "ARTHUR PEREIRA DA ROCHA", admissao: "2025-07-23" },
    { nome: "ESDRAS UCHOA PEDROSO", admissao: "2024-06-27" },
    { nome: "FELIPE AMAZONAS DE AZEVEDO", admissao: "2022-10-26" },
    { nome: "FELIPE CASTRO GOMES", admissao: "2022-07-11" },
    { nome: "GUSTAVO SOUZA AMARAL", admissao: "2023-07-03" },
    { nome: "JONAS SALLES PEREIRA", admissao: "2025-02-25" },
    { nome: "LEONARDO SOUZA DE OLIVEIRA MOURA", admissao: "2023-06-01" },
    { nome: "MAYARA DE SOUZA MARTINS", admissao: "2024-09-03" },
    { nome: "RAPHAEL RICARDO DE SOUZA BARROS", admissao: "2023-10-10" },
    { nome: "RENATA RODRIGUES GOMES", admissao: "2023-12-11" },
    { nome: "RODOLPHO MAGNUS ALVES LOPES", admissao: "2021-09-15" },
    { nome: "THAIS NUNES ALVES", admissao: "2021-01-11" },
    { nome: "THIAGO LUCENA CARVALHO", admissao: "2025-05-21" }
];

// Preenche o select
const selectColab = document.getElementById("colaborador");
colaboradores.forEach(c => {
    let opt = document.createElement("option");
    opt.value = c.nome;
    opt.textContent = c.nome;
    selectColab.appendChild(opt);
});

let ferias = JSON.parse(localStorage.getItem("ferias")) || [];
let supervisorLogado = false;

function salvar() {
    localStorage.setItem("ferias", JSON.stringify(ferias));
}

function renderFerias() {
    const tbody = document.getElementById("listaFerias");
    tbody.innerHTML = "";

    ferias.sort((a, b) => new Date(a.admissao) - new Date(b.admissao));

    ferias.forEach((f, idx) => {
        const statusTexto = f.status + (f.formularioEnviado ? " - Enviado" : "");

        let tr = document.createElement("tr");

        tr.innerHTML = `
            <td>${f.nome}</td>
            <td>${f.inicio}</td>
            <td>${f.fim}</td>
            <td>${f.retorno}</td>
            <td class="${f.status.toLowerCase()}">${statusTexto}</td>
            <td style="text-align:center;">
                ${supervisorLogado ? 
                    `<button class="btn aprovado" onclick="aprovar(${idx})">Aprovar</button>
                     <button class="btn negado" onclick="negar(${idx})">Negar</button>
                     <button class="btn" style="background:#555; margin-left:5px;" onclick="excluir(${idx})">Excluir</button>`
                : ""}
            </td>
            <td style="text-align:center;">
                ${supervisorLogado ? 
                    `<input type="checkbox" id="chkRH_${idx}" ${f.formularioEnviado ? "checked" : ""} onchange="toggleFormularioRH(${idx})">`
                    : (f.formularioEnviado ? "✔" : "")
                }
            </td>
        `;

        tbody.appendChild(tr);
    });
}

function toggleFormularioRH(idx) {
    ferias[idx].formularioEnviado = !ferias[idx].formularioEnviado;
    salvar();
    renderFerias();
}

function baixarCSV() {
    if (ferias.length === 0) {
        alert("Nenhuma solicitação para exportar.");
        return;
    }

    const headers = ["Colaborador", "Início", "Fim", "Retorno", "Status", "Admissão", "Formulário RH"];
    const linhas = ferias.map(f => [
        f.nome, f.inicio, f.fim, f.retorno, f.status, f.admissao, f.formularioEnviado ? "Sim" : "Não"
    ]);

    let csvContent = "";
    csvContent += headers.join(",") + "\n";
    linhas.forEach(linha => {
        const escaped = linha.map(campo => `"${String(campo).replace(/"/g, '""')}"`);
        csvContent += escaped.join(",") + "\n";
    });

    const blob = new Blob([csvContent], {type: 'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = "solicitacoes_ferias.csv";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function baixarExcel() {
    if (ferias.length === 0) {
        alert("Nenhuma solicitação para exportar.");
        return;
    }

    const dados = [
        ["Colaborador", "Início", "Fim", "Retorno", "Status", "Admissão", "Formulário RH"]
    ];

    ferias.forEach(f => {
        dados.push([
            f.nome,
            f.inicio,
            f.fim,
            f.retorno,
            f.status,
            f.admissao,
            f.formularioEnviado ? "Sim" : "Não"
        ]);
    });

    const ws = XLSX.utils.aoa_to_sheet(dados);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Solicitações");

    XLSX.writeFile(wb, "solicitacoes_ferias.xlsx");
}

function verificaConflito(inicio, fim) {
    return ferias.some(f => {
        if (f.status === "Negado") return false;
        return (
            (inicio >= f.inicio && inicio <= f.fim) ||
            (fim >= f.inicio && fim <= f.fim) ||
            (inicio <= f.inicio && fim >= f.fim)
        );
    });
}

const inputInicio = document.getElementById("inicio");

function formatDateToYYYYMMDD(date) {
    const yyyy = date.getFullYear();
    let mm = date.getMonth() + 1;
    let dd = date.getDate();
    if (mm < 10) mm = '0' + mm;
    if (dd < 10) dd = '0' + dd;
    return `${yyyy}-${mm}-${dd}`;
}

window.onload = () => {
    const hoje = new Date();
    const maxDate = new Date("2030-12-31");
    inputInicio.min = formatDateToYYYYMMDD(hoje);
    inputInicio.max = formatDateToYYYYMMDD(maxDate);
};

document.getElementById("duracao").addEventListener("change", () => {
    const inicio = inputInicio.value;
    const duracao = parseInt(document.getElementById("duracao").value);
    if (!inicio || !duracao) return;

    const dataInicio = new Date(inicio);
    const dataFim = new Date(dataInicio);
    dataFim.setDate(dataFim.getDate() + duracao - 1);

    const retorno = new Date(dataFim);
    retorno.setDate(retorno.getDate() + 1);

    document.getElementById("infoRetorno").textContent =
        `Férias até ${dataFim.toLocaleDateString("pt-BR")} - Retorno: ${retorno.toLocaleDateString("pt-BR")}`;
});

function agendarFerias() {
    const nome = selectColab.value;
    const inicio = inputInicio.value;
    const duracao = parseInt(document.getElementById("duracao").value);

    if (!inicio || !duracao) {
        alert("Preencha a data de início e a duração.");
        return;
    }

    if (![15, 20, 30].includes(duracao)) {
        alert("Somente 15, 20 ou 30 dias são permitidos.");
        return;
    }

    const dataInicio = new Date(inicio);
    const hoje = new Date();
    hoje.setHours(0,0,0,0);
    const maxAno = new Date("2030-12-31");
    maxAno.setHours(23,59,59,999);

    if (dataInicio < hoje) {
        alert("A data de início não pode ser no passado.");
        return;
    }

    if (dataInicio > maxAno) {
        alert("A data de início não pode ser após 31/12/2030.");
        return;
    }

    const dataFim = new Date(dataInicio);
    dataFim.setDate(dataFim.getDate() + duracao - 1);

    const retorno = new Date(dataFim);
    retorno.setDate(retorno.getDate() + 1);

    if (verificaConflito(inicio, dataFim.toISOString().split("T")[0])) {
        alert("Já existe alguém de férias nesse período.");
        return;
    }

    const admissao = colaboradores.find(c => c.nome === nome).admissao;
    ferias.push({ 
        nome, 
        inicio, 
        fim: dataFim.toISOString().split("T")[0], 
        retorno: retorno.toISOString().split("T")[0],
        status: "Pendente", 
        admissao,
        formularioEnviado: false
    });
    salvar();
    renderFerias();
    alert("Aguardando aprovação do supervisor.");
}

function loginSupervisor() {
    const senha = document.getElementById("senhaSupervisor").value;
    if (senha === "supervisor") {
        supervisorLogado = true;
        alert("Supervisor logado.");
        renderFerias();
    } else {
        alert("Senha incorreta.");
    }
}

function aprovar(idx) {
    ferias[idx].status = "Aprovado";
    salvar();
    renderFerias();
}

function negar(idx) {
    ferias[idx].status = "Negado";
    salvar();
    renderFerias();
}

function excluir(idx) {
    if (confirm("Tem certeza que deseja excluir esta solicitação de férias?")) {
        ferias.splice(idx, 1);
        salvar();
        renderFerias();
    }
}

renderFerias();
</script>

</body>
</html>
